-- ========================================================
-- Simplified Sensor Data Load - Snowsight Ready
-- ========================================================
-- This version uses a staging table approach that's more reliable
-- ========================================================

USE DATABASE UTILITIES_GRID_RELIABILITY;
USE SCHEMA RAW;
USE WAREHOUSE COMPUTE_WH;

-- Step 1: Create a staging table with VARIANT column
CREATE OR REPLACE TABLE SENSOR_READINGS_STAGE (
    JSON_DATA VARIANT
);

-- Step 2: List files to confirm they're already uploaded
LIST @SENSOR_DATA_STAGE;

-- Step 3: Load JSON into staging table
COPY INTO SENSOR_READINGS_STAGE
FROM @SENSOR_DATA_STAGE
FILE_FORMAT = JSON_FORMAT
ON_ERROR = 'CONTINUE';

-- Step 4: Check how many rows loaded
SELECT COUNT(*) AS STAGED_ROWS FROM SENSOR_READINGS_STAGE;

-- Step 5: Insert from staging table into final table
INSERT INTO SENSOR_READINGS (
    ASSET_ID,
    READING_TIMESTAMP,
    OIL_TEMPERATURE_C,
    WINDING_TEMPERATURE_C,
    AMBIENT_TEMP_C,
    BUSHING_TEMP_C,
    LOAD_CURRENT_A,
    LOAD_VOLTAGE_KV,
    POWER_FACTOR,
    PARTIAL_DISCHARGE_PC,
    HUMIDITY_PCT,
    VIBRATION_MM_S,
    ACOUSTIC_DB,
    DISSOLVED_H2_PPM,
    DISSOLVED_CO_PPM,
    DISSOLVED_CO2_PPM,
    DISSOLVED_CH4_PPM,
    TAP_POSITION
)
SELECT 
    JSON_DATA:ASSET_ID::VARCHAR(50),
    JSON_DATA:READING_TIMESTAMP::TIMESTAMP,
    JSON_DATA:OIL_TEMPERATURE_C::NUMBER(5,2),
    JSON_DATA:WINDING_TEMPERATURE_C::NUMBER(5,2),
    JSON_DATA:AMBIENT_TEMP_C::NUMBER(5,2),
    JSON_DATA:BUSHING_TEMP_C::NUMBER(5,2),
    JSON_DATA:LOAD_CURRENT_A::NUMBER(10,2),
    JSON_DATA:LOAD_VOLTAGE_KV::NUMBER(10,2),
    JSON_DATA:POWER_FACTOR::NUMBER(5,4),
    JSON_DATA:PARTIAL_DISCHARGE_PC::NUMBER(8,2),
    JSON_DATA:HUMIDITY_PCT::NUMBER(5,2),
    JSON_DATA:VIBRATION_MM_S::NUMBER(8,4),
    JSON_DATA:ACOUSTIC_DB::NUMBER(6,2),
    JSON_DATA:DISSOLVED_H2_PPM::NUMBER(10,2),
    JSON_DATA:DISSOLVED_CO_PPM::NUMBER(10,2),
    JSON_DATA:DISSOLVED_CO2_PPM::NUMBER(10,2),
    JSON_DATA:DISSOLVED_CH4_PPM::NUMBER(10,2),
    JSON_DATA:TAP_POSITION::NUMBER(3,0)
FROM SENSOR_READINGS_STAGE;

-- Step 6: Verify final count
SELECT 
    COUNT(*) AS TOTAL_READINGS,
    COUNT(DISTINCT ASSET_ID) AS UNIQUE_ASSETS,
    MIN(READING_TIMESTAMP) AS EARLIEST_READING,
    MAX(READING_TIMESTAMP) AS LATEST_READING
FROM SENSOR_READINGS;

-- Step 7: Sample the data
SELECT * FROM SENSOR_READINGS ORDER BY READING_TIMESTAMP DESC LIMIT 10;

-- Step 8: Clean up staging table (optional)
-- DROP TABLE SENSOR_READINGS_STAGE;

-- ========================================================
-- Expected Results:
-- TOTAL_READINGS: 432,000
-- UNIQUE_ASSETS: 100
-- EARLIEST_READING: 2025-05-20 13:20:59
-- LATEST_READING: 2025-11-16 12:20:59
-- ========================================================

