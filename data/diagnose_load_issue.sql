-- ========================================================
-- Diagnose COPY INTO Load Issue
-- ========================================================
USE DATABASE UTILITIES_GRID_RELIABILITY;
USE SCHEMA RAW;

-- 1. Check what files are in the stage
LIST @SENSOR_DATA_STAGE;

-- 2. Check how many rows were loaded
SELECT COUNT(*) AS ROWS_LOADED FROM SENSOR_READINGS;

-- 3. Check the COPY INTO history to see what happened
SELECT 
    FILE_NAME,
    FILE_SIZE,
    ROW_COUNT,
    ROW_PARSED,
    FIRST_ERROR_MESSAGE,
    FIRST_ERROR_LINE_NUMBER,
    STATUS
FROM TABLE(INFORMATION_SCHEMA.COPY_HISTORY(
    TABLE_NAME => 'SENSOR_READINGS',
    START_TIME => DATEADD(HOURS, -1, CURRENT_TIMESTAMP())
))
ORDER BY LAST_LOAD_TIME DESC;

-- 4. If you need to reload, first truncate (optional)
-- TRUNCATE TABLE SENSOR_READINGS;

-- 5. Alternative COPY INTO with better error handling
COPY INTO SENSOR_READINGS (
    ASSET_ID,
    READING_TIMESTAMP,
    OIL_TEMPERATURE_C,
    WINDING_TEMPERATURE_C,
    LOAD_CURRENT_A,
    LOAD_VOLTAGE_KV,
    AMBIENT_TEMP_C,
    HUMIDITY_PCT,
    VIBRATION_MM_S,
    ACOUSTIC_DB,
    DISSOLVED_H2_PPM,
    DISSOLVED_CO_PPM,
    DISSOLVED_CO2_PPM,
    DISSOLVED_CH4_PPM,
    BUSHING_TEMP_C,
    TAP_POSITION,
    PARTIAL_DISCHARGE_PC,
    POWER_FACTOR
)
FROM (
    SELECT 
        $1:ASSET_ID::VARCHAR(50),
        $1:READING_TIMESTAMP::TIMESTAMP,
        $1:OIL_TEMPERATURE_C::NUMBER(5,2),
        $1:WINDING_TEMPERATURE_C::NUMBER(5,2),
        $1:LOAD_CURRENT_A::NUMBER(10,2),
        $1:LOAD_VOLTAGE_KV::NUMBER(10,2),
        $1:AMBIENT_TEMP_C::NUMBER(5,2),
        $1:HUMIDITY_PCT::NUMBER(5,2),
        $1:VIBRATION_MM_S::NUMBER(8,4),
        $1:ACOUSTIC_DB::NUMBER(6,2),
        $1:DISSOLVED_H2_PPM::NUMBER(10,2),
        $1:DISSOLVED_CO_PPM::NUMBER(10,2),
        $1:DISSOLVED_CO2_PPM::NUMBER(10,2),
        $1:DISSOLVED_CH4_PPM::NUMBER(10,2),
        $1:BUSHING_TEMP_C::NUMBER(5,2),
        $1:TAP_POSITION::NUMBER(3,0),
        $1:PARTIAL_DISCHARGE_PC::NUMBER(8,2),
        $1:POWER_FACTOR::NUMBER(5,4)
    FROM @SENSOR_DATA_STAGE
)
PATTERN = '.*sensor_readings_batch.*\\.json.*'
FILE_FORMAT = (TYPE = 'JSON')
ON_ERROR = 'CONTINUE'
FORCE = TRUE
RETURN_FAILED_ONLY = FALSE;

-- 6. Verify final count
SELECT 
    COUNT(*) AS TOTAL_READINGS,
    COUNT(DISTINCT ASSET_ID) AS UNIQUE_ASSETS,
    MIN(READING_TIMESTAMP) AS EARLIEST_READING,
    MAX(READING_TIMESTAMP) AS LATEST_READING
FROM SENSOR_READINGS;

